trigger:
  branches:
    include:
      - main

variables:
  environment: 'dev'

stages:
  - stage: Terraform
    jobs:
    - job: Terraformjob
      pool:
        vmImage: 'ubuntu-latest'

      steps:
      - task: AzureKeyVault@2
        inputs:
          azureSubscription: 'bestrong-arm'
          KeyVaultName: 'newbestrongkeyvault'
          SecretsFilter: 'TerraformClientId,TerraformTenantId,TerraformClientSecret,TerraformSubscriptionId'
          RunAsPreJob: true
      - script: |
          echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$(TerraformClientId)"
          echo "##vso[task.setvariable variable=ARM_TENANT_ID]$(TerraformTenantId)"
          echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET]$(TerraformClientSecret)"
          echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$(TerraformSubscriptionId)"
        displayName: 'Set Terraform environment variables'

      - task: TerraformInstaller@1
        inputs:
          terraformVersion: '1.6.6' 
      - script: |
          echo "Client ID: $(TerraformClientId)"
          echo "Tenant ID: $(TerraformTenantId)"
          echo "Client Secret Length: ${#TerraformClientSecret}"
        displayName: 'Verify secret values (masked)'


      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'init'
          commandOptions: '-backend-config=resource_group_name=rg-terraform-state -backend-config=storage_account_name=tfstatestoragebestrong -backend-config=container_name=tfstate -backend-config=key=tfstate'
          backendAzureRmUseEntraIdForAuthentication: false
          backendServiceArm: 'Subscription(52ecb237-db48-4ae0-b22c-9fc43dd0742a)'


      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'custom'
          outputTo: 'console'
          customCommand: 'terraform workspace select $(environment)'
          environmentServiceNameAzureRM: 'bestrong-arm'
        displayName: 'Terrafrom workspace select'
          
      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'plan'
          commandOptions: '-var-file="env/$(environment).tfvars"'
          environmentServiceNameAzureRM: 'bestrong-arm'
        displayName: 'Terraform plan'
      
      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'apply'
          commandOptions: '-var-file="env/$(environment).tfvars"'
          environmentServiceNameAzureRM: 'bestrong-arm'
        displayName: 'Terraform apply'