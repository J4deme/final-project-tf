trigger:
  branches:
    include:
      - main

variables:
  environment: 'dev'

stages:
  - stage: Terraform
    jobs:
    - job: Terraformjob
      pool:
        vmImage: 'ubuntu-latest'

      steps:
      - task: AzureKeyVault@2
        inputs:
          azureSubscription: 'bestrong-arm'
          KeyVaultName: 'newbestrongkeyvault'
          SecretsFilter: 'TerraformClientId,TerraformTenantId,TerraformClientSecret,TerraformSubscriptionId'
          RunAsPreJob: true
      - script: |
          echo "##vso[task.setvariable variable=ARM_CLIENT_ID]$(TerraformClientId)"
          echo "##vso[task.setvariable variable=ARM_TENANT_ID]$(TerraformTenantId)"
          echo "##vso[task.setvariable variable=ARM_CLIENT_SECRET]$(TerraformClientSecret)"
          echo "##vso[task.setvariable variable=ARM_SUBSCRIPTION_ID]$(TerraformSubscriptionId)"
        displayName: 'Set Terraform environment variables'

      - task: TerraformInstaller@1
        inputs:
          terraformVersion: '1.6.6' 

      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'init'
          backendServiceArm: 'bestrong-arm'
          backendAzureRmStorageAccountName: 'tfstatestoragebestrong'
          backendAzureRmContainerName: 'tfstate'
          backendAzureRmKey: 'terraform.tfstate'
        displayName: 'Terraform init'

      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'custom'
          outputTo: 'console'
          customCommand: 'terraform workspace select $(environment)'
          environmentServiceNameAzureRM: 'bestrong-arm'
        displayName: 'Terrafrom workspace select'
          
      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'plan'
          commandOptions: '-var-file="env/$(environment).tfvars"'
          environmentServiceNameAzureRM: 'bestrong-arm'
        displayName: 'Terraform plan'
      
      - task: TerraformTask@5
        inputs:
          provider: 'azurerm'
          command: 'apply'
          commandOptions: '-var-file="env/$(environment).tfvars"'
          environmentServiceNameAzureRM: 'bestrong-arm'
        displayName: 'Terraform apply'